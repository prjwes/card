<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        input {
            margin: 10px;
            padding: 8px;
        }
        #preview {
            text-align: left;
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 20px;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        @media (max-width: 600px) {
            button, input {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Card Generator</h1>
    <div id="grade-selection">
        <button onclick="selectGrade(7)">Grade 7</button>
        <button onclick="selectGrade(8)">Grade 8</button>
        <button onclick="selectGrade(9)">Grade 9</button>
    </div>
    <div id="form-section" class="hidden">
        <label for="term">Term:</label>
        <input type="text" id="term">
        <label for="year">Year:</label>
        <input type="text" id="year">
        <label for="exam1">Upload Exam 1 (Excel):</label>
        <input type="file" id="exam1" accept=".xlsx">
        <label for="exam2">Upload Exam 2 (Excel):</label>
        <input type="file" id="exam2" accept=".xlsx">
        <button onclick="generateCards()">Generate</button>
    </div>
    <div id="result-section" class="hidden">
        <p id="status"></p>
        <div id="preview"></div>
        <button id="download-btn" class="hidden" onclick="downloadExcel()">Save on Phone</button>
    </div>

    <script>
        let selectedGrade = null;
        let wb = null;

        function selectGrade(grade) {
            selectedGrade = grade;
            document.getElementById('grade-selection').classList.add('hidden');
            document.getElementById('form-section').classList.remove('hidden');
        }

        function colToIndex(col) {
            return col.charCodeAt(0) - 'A'.charCodeAt(0);
        }

        function addCell(ws, addr, value) {
            if (value === undefined || value === null) return;
            const cell = { v: value };
            if (typeof value === 'number') {
                cell.t = 'n';
            } else {
                cell.t = 's';
            }
            ws[addr] = cell;
        }

        function addFixedCells(ws) {
            addCell(ws, 'D1', 'REPORT FORM');
            addCell(ws, 'B2', 'LEARNER\'S NAME: ');
            addCell(ws, 'D2', 'ADM: ');
            addCell(ws, 'B3', 'GRADE: ');
            addCell(ws, 'D3', 'TERM: ');
            addCell(ws, 'F3', 'YEAR: ');
            addCell(ws, 'B5', 's/no');
            addCell(ws, 'C5', 'learning area');
            addCell(ws, 'D5', 'exam 1');
            addCell(ws, 'E5', 'rubric');
            addCell(ws, 'F5', 'exam 2');
            addCell(ws, 'G5', 'rubric2');
            addCell(ws, 'H5', 'comment');
            addCell(ws, 'B6', '1');
            addCell(ws, 'C6', 'English');
            addCell(ws, 'B7', '2');
            addCell(ws, 'C7', 'Kiswahili');
            addCell(ws, 'B8', '3');
            addCell(ws, 'C8', 'Mathematics');
            addCell(ws, 'B9', '4');
            addCell(ws, 'C9', 'Intergrated science');
            addCell(ws, 'B10', '5');
            addCell(ws, 'C10', 'c.r.e');
            addCell(ws, 'B11', '6');
            addCell(ws, 'C11', 'c.a & sports');
            addCell(ws, 'B12', '7');
            addCell(ws, 'C12', 'Pre.technical studies');
            addCell(ws, 'B13', '8');
            addCell(ws, 'C13', 'Social studies');
            addCell(ws, 'B14', '9');
            addCell(ws, 'C14', 'Agriculture');
            addCell(ws, 'C15', 'Average');
            addCell(ws, 'A16', 'Facilitator’s remarks based on: core competences, achievements, PCI’s development and values.');
            addCell(ws, 'A17', '1.BELOW EXPECTATIONS {B.E}    2. APPROACH EXPECTATIONS {A.E}');
            addCell(ws, 'A18', '3. MEETING EXPECTATIONS {M.E}     4. EXCEEDING EXPECTATIONS {E.E}');
            addCell(ws, 'A19', 'FACILITATOR’S SIGNATURE………………….… DATE………………….…');
            addCell(ws, 'A21', 'HEAD TEACHER’S SIGNATURE…………………. ');
            addCell(ws, 'A23', 'DATE………………….');
            addCell(ws, 'A25', 'PARENT’S SIGNATURE………………….DATE………………….');
            addCell(ws, 'A26', 'THE TERM STARTED ON: 6/1/2025   CLOSING DATE: 4/4/2025');
            addCell(ws, 'A27', 'NEXT TERM BEGINS ON: 28/4/2025');
        }

        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function generateCards() {
            const term = document.getElementById('term').value.trim();
            const year = document.getElementById('year').value.trim();
            const exam1File = document.getElementById('exam1').files[0];
            const exam2File = document.getElementById('exam2').files[0];

            if (!selectedGrade || !term || !year || !exam1File || !exam2File) {
                alert('Please fill all fields and upload both files.');
                return;
            }

            document.getElementById('form-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('status').textContent = 'Generating...';

            try {
                const data1 = await readFile(exam1File);
                const data2 = await readFile(exam2File);

                const wb1 = XLSX.read(data1, { type: 'array' });
                const wb2 = XLSX.read(data2, { type: 'array' });

                const sheetName1 = wb1.SheetNames[0];
                const sheetName2 = wb2.SheetNames[0];

                const ws1 = wb1.Sheets[sheetName1];
                const ws2 = wb2.Sheets[sheetName2];

                const range1 = XLSX.utils.decode_range(ws1['!ref']);
                const range2 = XLSX.utils.decode_range(ws2['!ref']);
                const rowCount = Math.min(range1.e.r + 1, range2.e.r + 1);

                const mappings = [
                    { col: 'D', exam1: 'D6', exam2: 'F6' },
                    { col: 'E', exam1: 'E6', exam2: 'G6' },
                    { col: 'F', exam1: 'D7', exam2: 'F7' },
                    { col: 'G', exam1: 'E7', exam2: 'G7' },
                    { col: 'H', exam1: 'D8', exam2: 'F8' },
                    { col: 'I', exam1: 'E8', exam2: 'G8' },
                    { col: 'J', exam1: 'D9', exam2: 'F9' },
                    { col: 'K', exam1: 'E9', exam2: 'G9' },
                    { col: 'L', exam1: 'D10', exam2: 'F10' },
                    { col: 'M', exam1: 'E10', exam2: 'G10' },
                    { col: 'N', exam1: 'D11', exam2: 'F11' },
                    { col: 'O', exam1: 'E11', exam2: 'G11' },
                    { col: 'P', exam1: 'D12', exam2: 'F12' },
                    { col: 'Q', exam1: 'E12', exam2: 'G12' },
                    { col: 'R', exam1: 'D13', exam2: 'F13' },
                    { col: 'S', exam1: 'E13', exam2: 'G13' },
                    { col: 'T', exam1: 'D14', exam2: 'F14' },
                    { col: 'U', exam1: 'E14', exam2: 'G14' },
                    { col: 'V', exam1: 'D16', exam2: 'F16' },
                    { col: 'W', exam1: 'E16', exam2: 'G16' },
                    { col: 'X', exam1: 'H16', exam2: null }
                ];

                wb = XLSX.utils.book_new();
                const previewDiv = document.getElementById('preview');
                previewDiv.innerHTML = '';

                for (let i = 3; i < rowCount; i++) {
                    const rowNum = i + 1;
                    const adm = ws1[`B${rowNum}`]?.v || '';
                    const name = ws1[`C${rowNum}`]?.v || '';

                    if (!adm || !name) continue;

                    const ws = {};

                    addFixedCells(ws);

                    addCell(ws, 'B2', `LEARNER'S NAME: ${name}`);
                    addCell(ws, 'D2', `ADM: ${adm}`);
                    addCell(ws, 'B3', `GRADE: ${selectedGrade}`);
                    addCell(ws, 'D3', `TERM: ${term}`);
                    addCell(ws, 'F3', `YEAR: ${year}`);

                    mappings.forEach(m => {
                        const colIdx = colToIndex(m.col);
                        const cell1 = ws1[XLSX.utils.encode_cell({ r: i, c: colIdx })];
                        const cell2 = m.exam2 ? ws2[XLSX.utils.encode_cell({ r: i, c: colIdx })] : null;
                        if (m.exam1 && cell1) addCell(ws, m.exam1, cell1.v);
                        if (m.exam2 && cell2) addCell(ws, m.exam2, cell2.v);
                    });

                    ws['!ref'] = 'A1:H28';
                    ws['!cols'] = [{ wch: 30 }, { wch: 10 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 20 }];

                    const sheetName = `Card_${adm || i}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);

                    const html = XLSX.utils.sheet_to_html(ws, { editable: false });
                    previewDiv.innerHTML += `<h3>${sheetName}</h3>${html}`;
                }

                if (wb.SheetNames.length === 0) {
                    throw new Error('No valid data found in the uploaded files.');
                }

                document.getElementById('status').textContent = 'Generation successful!';
                document.getElementById('download-btn').classList.remove('hidden');
            } catch (error) {
                document.getElementById('status').textContent = `Error: ${error.message}`;
                document.getElementById('download-btn').classList.add('hidden');
            }
        }

        function downloadExcel() {
            if (wb && wb.SheetNames.length > 0) {
                XLSX.writeFile(wb, 'generated_cards.xlsx');
            } else {
                alert('No cards generated to download.');
            }
        }
    </script>
</body>
</html>
